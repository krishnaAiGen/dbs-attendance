generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  student
  professor
}

model ProfessorKey {
  id          String     @id @default(cuid())
  keyCode     String     @unique @map("key_code")
  subjectName String     @map("subject_name")
  isUsed      Boolean    @default(false) @map("is_used")
  professor   Professor?

  @@map("professor_keys")
}

model User {
  id           String              @id @default(cuid())
  email        String              @unique
  passwordHash String              @map("password_hash")
  role         Role
  fullName     String              @map("full_name")
  createdAt    DateTime            @default(now()) @map("created_at")
  professor    Professor?
  attendance   AttendanceRecord[]
  submissions  Submission[]

  @@map("users")
}

model Professor {
  id             String              @id @default(cuid())
  userId         String              @unique @map("user_id")
  professorKeyId String              @unique @map("professor_key_id")
  subjectName    String              @map("subject_name")
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  professorKey   ProfessorKey        @relation(fields: [professorKeyId], references: [id])
  sessions       AttendanceSession[]
  quizzes        Quiz[]

  @@map("professors")
}

model AttendanceSession {
  id            String             @id @default(cuid())
  professorId   String             @map("professor_id")
  subjectName   String             @map("subject_name")
  latitude      Float
  longitude     Float
  sessionSecret String             @map("session_secret")
  createdAt     DateTime           @default(now()) @map("created_at")
  expiresAt     DateTime           @map("expires_at")
  isActive      Boolean            @default(true) @map("is_active")
  professor     Professor          @relation(fields: [professorId], references: [id], onDelete: Cascade)
  records       AttendanceRecord[]

  @@map("attendance_sessions")
}

model AttendanceRecord {
  id              String            @id @default(cuid())
  sessionId       String            @map("session_id")
  studentId       String            @map("student_id")
  studentLatitude Float             @map("student_latitude")
  studentLongitude Float            @map("student_longitude")
  distanceMeters  Float             @map("distance_meters")
  markedAt        DateTime          @default(now()) @map("marked_at")
  session         AttendanceSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student         User              @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@map("attendance_records")
}

model QRToken {
  id        String   @id @default(cuid())
  token     String   @unique
  sessionId String   @map("session_id")
  timestamp BigInt
  nonce     String
  signature String
  createdAt DateTime @default(now()) @map("created_at")
  expiresAt DateTime @map("expires_at")

  @@index([expiresAt])
  @@map("qr_tokens")
}

model Quiz {
  id          String     @id @default(cuid())
  professorId String     @map("professor_id")
  title       String
  subject     String
  deadline    DateTime?
  createdAt   DateTime   @default(now()) @map("created_at")
  professor   Professor  @relation(fields: [professorId], references: [id], onDelete: Cascade)
  questions   Question[]
  submissions Submission[]

  @@map("quizzes")
}

model Question {
  id        String   @id @default(cuid())
  quizId    String   @map("quiz_id")
  text      String
  type      String   @default("MCQ") // MCQ, TEXT (Future)
  difficulty String  @default("MEDIUM") // LOW, MEDIUM, HARD
  createdAt DateTime @default(now()) @map("created_at")
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  options   Option[]
  answers   Answer[]

  @@map("questions")
}

model Option {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  text       String
  isCorrect  Boolean  @default(false) @map("is_correct")
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("options")
}

model Submission {
  id        String   @id @default(cuid())
  quizId    String   @map("quiz_id")
  studentId String   @map("student_id")
  score     Float    @default(0.0)
  submittedAt DateTime @default(now()) @map("submitted_at")
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  answers   Answer[]

  @@unique([quizId, studentId])
  @@map("submissions")
}

model Answer {
  id           String     @id @default(cuid())
  submissionId String     @map("submission_id")
  questionId   String     @map("question_id")
  selectedOptionId String? @map("selected_option_id") // For MCQ
  textAnswer    String?   @map("text_answer") // For Open Ended (Future)
  isCorrect     Boolean   @default(false) @map("is_correct")
  submission    Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question      Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("answers")
}

